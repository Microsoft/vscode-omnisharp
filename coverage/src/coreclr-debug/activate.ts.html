<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/coreclr-debug/activate.ts</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">src/coreclr-debug/activate.ts</span></h1>
    <h2>
        Statements: <span class="metric">24% <small>(18 / 75)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">7.5% <small>(3 / 40)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">20% <small>(2 / 10)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">24.32% <small>(18 / 74)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">src/coreclr-debug/</a> &#187; activate.ts</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
'use strict';
&nbsp;
import * as path from 'path';
import * as vscode from 'vscode';
import * as common from './../common';
&nbsp;
import { CoreClrDebugUtil, DotnetInfo, } from './util';
&nbsp;
import { Logger } from './../logger';
import { PlatformInformation } from './../platform';
import TelemetryReporter from 'vscode-extension-telemetry';
&nbsp;
let _debugUtil: CoreClrDebugUtil = null;
let _logger: Logger = null;
&nbsp;
export async function activate(thisExtension : vscode.Extension&lt;any&gt;, context: vscode.ExtensionContext, reporter: TelemetryReporter, logger: Logger, channel: vscode.OutputChannel) {
    _debugUtil = new CoreClrDebugUtil(context.extensionPath, logger);
    _logger = logger;
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!CoreClrDebugUtil.existsSync(_debugUtil.debugAdapterDir())) {
        let isInvalidArchitecture: boolean = <span class="cstat-no" title="statement not covered" >await checkForInvalidArchitecture(logger);</span>
<span class="cstat-no" title="statement not covered" >        if (!isInvalidArchitecture) {</span>
<span class="cstat-no" title="statement not covered" >            logger.appendLine("[ERROR]: C# Extension failed to install the debugger package.");</span>
<span class="cstat-no" title="statement not covered" >            showInstallErrorMessage(channel);</span>
        }
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (!CoreClrDebugUtil.existsSync(_debugUtil.installCompleteFilePath())) {
<span class="cstat-no" title="statement not covered" >        completeDebuggerInstall(logger, channel);</span>
    }
}
&nbsp;
async function checkForInvalidArchitecture(logger: Logger<span class="fstat-no" title="function not covered" >): Promise&lt;boolean&gt; {</span>
    let platformInformation: PlatformInformation;
        
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >        platformInformation = await PlatformInformation.GetCurrent();</span>
    }
    catch (err) {
        // Somehow we couldn't figure out the platform we are on
<span class="cstat-no" title="statement not covered" >        logger.appendLine("[ERROR] The debugger cannot be installed. Could not determine current platform.");</span>
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
    
<span class="cstat-no" title="statement not covered" >    if (platformInformation) {</span>
<span class="cstat-no" title="statement not covered" >        if (platformInformation.isMacOS() &amp;&amp; !CoreClrDebugUtil.isMacOSSupported()) {</span>
<span class="cstat-no" title="statement not covered" >            logger.appendLine("[ERROR] The debugger cannot be installed. The debugger requires macOS 10.12 (Sierra) or newer.");</span>
<span class="cstat-no" title="statement not covered" >            return true;</span>
        } 
        else <span class="cstat-no" title="statement not covered" >if (platformInformation.architecture !== "x86_64") {</span>
<span class="cstat-no" title="statement not covered" >            if (platformInformation.isWindows() &amp;&amp; platformInformation.architecture === "x86") {</span>
<span class="cstat-no" title="statement not covered" >                logger.appendLine(`[WARNING]: x86 Windows is not currently supported by the .NET Core debugger. Debugging will not be available.`);</span>
            } else {
<span class="cstat-no" title="statement not covered" >                logger.appendLine(`[WARNING]: Processor architecture '${platformInformation.architecture}' is not currently supported by the .NET Core debugger. Debugging will not be available.`);</span>
            }
<span class="cstat-no" title="statement not covered" >            return true;</span>
        }
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return false;</span>
}
&nbsp;
async function completeDebuggerInstall(logger: Logger, channel: vscode.OutputChannel<span class="fstat-no" title="function not covered" >) : Promise&lt;boolean&gt; {</span>
<span class="cstat-no" title="statement not covered" >    return _debugUtil.checkDotNetCli()</span>
        .then(async (dotnetInfo: DotnetInfo) =&gt;<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" > {</span></span>
            
            let isInvalidArchitecture: boolean = <span class="cstat-no" title="statement not covered" >await checkForInvalidArchitecture(logger);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (isInvalidArchitecture) {</span>
<span class="cstat-no" title="statement not covered" >                channel.show();</span>
<span class="cstat-no" title="statement not covered" >                vscode.window.showErrorMessage('Failed to complete the installation of the C# extension. Please see the error in the output window below.');</span>
<span class="cstat-no" title="statement not covered" >                return false;</span>
            }
&nbsp;
            // Write install.complete
<span class="cstat-no" title="statement not covered" >            CoreClrDebugUtil.writeEmptyFile(_debugUtil.installCompleteFilePath());</span>
<span class="cstat-no" title="statement not covered" >            vscode.window.setStatusBarMessage('Successfully installed .NET Core Debugger.', 5000);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            return true;</span>
        }, (err) =&gt;<span class="fstat-no" title="function not covered" > {</span>
            // Check for dotnet tools failed. pop the UI
            // err is a DotNetCliError but use defaults in the unexpected case that it's not
<span class="cstat-no" title="statement not covered" >            showDotnetToolsWarning(err.ErrorMessage || _debugUtil.defaultDotNetCliErrorMessage());</span>
<span class="cstat-no" title="statement not covered" >            _logger.appendLine(err.ErrorString || err);</span>
            // TODO: log telemetry?
&nbsp;
<span class="cstat-no" title="statement not covered" >            return false;</span>
        });
}
&nbsp;
function showInstallErrorMessage(channel: vscode.OutputChannel<span class="fstat-no" title="function not covered" >) {</span>
<span class="cstat-no" title="statement not covered" >    channel.show();</span>
<span class="cstat-no" title="statement not covered" >    vscode.window.showErrorMessage("An error occured during installation of the .NET Core Debugger. The C# extension may need to be reinstalled.");</span>
}
&nbsp;
function showDotnetToolsWarning(message: string<span class="fstat-no" title="function not covered" >) : void</span>
{
    const config = <span class="cstat-no" title="statement not covered" >vscode.workspace.getConfiguration('csharp');</span>
<span class="cstat-no" title="statement not covered" >    if (!config.get('suppressDotnetInstallWarning', false)) {</span>
        const getDotNetMessage = <span class="cstat-no" title="statement not covered" >'Get .NET CLI tools';</span>
        const goToSettingsMessage = <span class="cstat-no" title="statement not covered" >'Disable this message in user settings';</span>
        // Buttons are shown in right-to-left order, with a close button to the right of everything;
        // getDotNetMessage will be the first button, then goToSettingsMessage, then the close button.
<span class="cstat-no" title="statement not covered" >        vscode.window.showErrorMessage(message,</span>
            goToSettingsMessage, getDotNetMessage).then(value =&gt;<span class="fstat-no" title="function not covered" > {</span>
<span class="cstat-no" title="statement not covered" >                if (value === getDotNetMessage) {</span>
                    let open = <span class="cstat-no" title="statement not covered" >require('open');</span>
                    let dotnetcoreURL = <span class="cstat-no" title="statement not covered" >'https://www.microsoft.com/net/core';</span>
&nbsp;
                    // Windows redirects https://www.microsoft.com/net/core to https://www.microsoft.com/net/core#windowsvs2015
<span class="cstat-no" title="statement not covered" >                    if (process.platform == "win32")</span>
                    {
<span class="cstat-no" title="statement not covered" >                        dotnetcoreURL = dotnetcoreURL + '#windowscmd';</span>
                    }
&nbsp;
<span class="cstat-no" title="statement not covered" >                    open(dotnetcoreURL);</span>
                } else <span class="cstat-no" title="statement not covered" >if (value === goToSettingsMessage) {</span>
<span class="cstat-no" title="statement not covered" >                    vscode.commands.executeCommand('workbench.action.openGlobalSettings');</span>
                }
            });
    }
}
&nbsp;
interface AdapterExecutableCommand {
    command: string;
}
&nbsp;
// The default extension manifest calls this command as the adapterExecutableCommand
// If the debugger components have not finished downloading, the proxy displays an error message to the user
// Else it will launch the debug adapter
export async function getAdapterExecutionCommand(channel: vscode.OutputChannel): Promise&lt;AdapterExecutableCommand&gt; {
    let logger = new Logger(text =&gt; <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >channel.append(text))</span></span>;
    let util = new CoreClrDebugUtil(common.getExtensionPath(), logger);
&nbsp;
    // Check for .debugger folder. Handle if it does not exist.
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!CoreClrDebugUtil.existsSync(util.debugAdapterDir())) {
        // our install.complete file does not exist yet, meaning we have not completed the installation. Try to figure out what if anything the package manager is doing
        // the order in which files are dealt with is this:
        // 1. install.Begin is created
        // 2. install.Lock is created
        // 3. install.Begin is deleted
        // 4. install.complete is created
        
        // install.Lock does not exist, need to wait for packages to finish downloading.
        let installLock: boolean = <span class="cstat-no" title="statement not covered" >await common.installFileExists(common.InstallFileType.Lock);</span>
<span class="cstat-no" title="statement not covered" >        if (!installLock) {</span>
<span class="cstat-no" title="statement not covered" >            channel.show();</span>
<span class="cstat-no" title="statement not covered" >            throw new Error('The C# extension is still downloading packages. Please see progress in the output window below.');</span>
        }
        // install.complete does not exist, check dotnetCLI to see if we can complete.
        else <span class="cstat-no" title="statement not covered" >if (!CoreClrDebugUtil.existsSync(util.installCompleteFilePath())) {</span>
            let success: boolean = <span class="cstat-no" title="statement not covered" >await completeDebuggerInstall(logger, channel);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (!success) {</span>
<span class="cstat-no" title="statement not covered" >                channel.show();</span>
<span class="cstat-no" title="statement not covered" >                throw new Error('Failed to complete the installation of the C# extension. Please see the error in the output window below.');</span>
            }
        }
    }
&nbsp;
    // debugger has finished installation, kick off our debugger process
    return {
        command: path.join(common.getExtensionPath(), ".debugger", "vsdbg-ui" + CoreClrDebugUtil.getPlatformExeExtension())
    };
}</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 09 2018 19:23:26 GMT-0800 (PST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
