name: Update Fork and Apply Patches


on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_ci:
        description: 'Override failure condition to force CI workflow to run'
        type: boolean
        default: false
        required: false
  push:
    branches:
      - main
  # push:
  #   branches: [ main, feature/** ]

  # pull_request:
  #   branches: [ main, feature/** ]

jobs:
  update-and-patch-fork:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

      - name: Add Upstream
        run: git remote add upstream https://github.com/dotnet/vscode-csharp.git

      - name: Fetch Upstream
        run: git fetch upstream

      - name: Check for Upstream Changes
        id: check-changes
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "Upstream commits: $UPSTREAM_COMMITS"
          echo "::set-output name=upstream_commits::$UPSTREAM_COMMITS"

      - name: Check Last Run of OmniSharp-VSCode CI
        id: check-ci
        uses: actions/github-script@v6
        with:
          script: |
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const ciWorkflow = workflows.workflows.find(workflow => workflow.name === 'OmniSharp-VSCode CI');
            if (!ciWorkflow) {
              core.setFailed('OmniSharp-VSCode CI workflow not found');
              return;
            }

            const { data: workflowRuns } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: ciWorkflow.id,
              per_page: 1,
              status: 'success'
            });

            if (workflowRuns.total_count > 0) {
              console.log('The last run of OmniSharp-VSCode CI succeeded');
              core.setOutput('ci_success', 'true');
            } else {
              console.log('The last run of OmniSharp-VSCode CI did not succeed');
              core.setOutput('ci_success', 'false');
            }

      - name: Set Override Failure from Manual Worfklow Dispatch
        if: github.event_name == 'workflow_dispatch'
        run: echo "FORCE_CI=${{ github.event.inputs.force_ci }}" >> $GITHUB_ENV

      - name: Set Override Failure from Commit Message
        if: github.event_name == 'push'
        run: |
          if [[ "$(git log -1 --pretty=%B)" == *"[force-ci]"* ]]; then
            echo "FORCE_CI=true" >> $GITHUB_ENV
          else
            echo "FORCE_CI=false" >> $GITHUB_ENV
          fi

      - name: Get current date (After Patch)
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d %R')"

      - name: Checkout Upstream Changes (without .github)
        run: |
          git checkout upstream/main -- .
          git reset HEAD .github
          git restore --staged .github
          git add -- ':!./.github'
          git commit -m "[pre-patch] Update from upstream at ${{ steps.date.outputs.date }}"
          git push origin main

      - name: Apply Patches
        run: |
          PATCHER="___patching/patcher.sh"
          chmod +x "$PATCHER"
          . "$PATCHER"

      - name: Sync/Merge With Upstream (without .github)
        run: |
          git checkout main
          git merge --no-commit --no-ff upstream/main
          git reset -- ./.github

      - name: Commit & Push Changes
        run: |
          git reset HEAD .github
          git restore --staged .github
          git add -- ':!./.github'
          git commit -m "[post-patch] patching at ${{ steps.date.outputs.date }}"
          git push origin main

      - name: Skip proceeding to build if no upstream changes and last CI succeeded
        if: steps.check-changes.outputs.upstream_commits == '0' && steps.check-ci.outputs.ci_success == 'true' && env.FORCE_CI != 'true'
        run: |
          echo "No changes in upstream repository and the last run of OmniSharp-VSCode CI succeeded. Failing the workflow."
          exit 1